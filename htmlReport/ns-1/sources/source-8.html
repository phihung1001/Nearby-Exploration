


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > WeatherServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.foodtourbackend.service.serviceImpl</a>
</div>

<h1>Coverage Summary for Class: WeatherServiceImpl (com.example.foodtourbackend.service.serviceImpl)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">WeatherServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.foodtourbackend.service.serviceImpl;
&nbsp;
&nbsp;import com.example.foodtourbackend.DTO.response.OpenMeteoResponseDTO;
&nbsp;import com.example.foodtourbackend.DTO.HourlyForecastDTO;
&nbsp;import com.example.foodtourbackend.DTO.WeatherDTO;
&nbsp;import com.example.foodtourbackend.service.WeatherService;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.web.reactive.function.client.WebClient;
&nbsp;import reactor.core.publisher.Mono;
&nbsp;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.IntStream;
&nbsp;
&nbsp;/**
&nbsp; * Tri·ªÉn khai d·ªãch v·ª• th·ªùi ti·∫øt, l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt t·ª´ Open-Meteo API
&nbsp; * v√† th√¥ng tin v·ªã tr√≠ t·ª´ OpenStreetMap (Nominatim API).
&nbsp; */
<b class="nc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;@Service
&nbsp;public class WeatherServiceImpl implements WeatherService {
&nbsp;
&nbsp;  private final WebClient webClient;
&nbsp;  private final ObjectMapper objectMapper;
&nbsp;
&nbsp;  // B·∫£n ƒë·ªì √°nh x·∫° m√£ th·ªùi ti·∫øt sang bi·ªÉu t∆∞·ª£ng t∆∞∆°ng ·ª©ng
<b class="nc">&nbsp;  private static final Map&lt;Integer, String&gt; WEATHER_ICONS = Map.of(</b>
<b class="nc">&nbsp;    0, &quot;‚òÄÔ∏è&quot;, 1, &quot;üå§Ô∏è&quot;, 2, &quot;‚õÖ&quot;, 3, &quot;‚òÅÔ∏è&quot;,</b>
<b class="nc">&nbsp;    45, &quot;üå´Ô∏è&quot;, 51, &quot;üå¶Ô∏è&quot;, 61, &quot;üåßÔ∏è&quot;,</b>
<b class="nc">&nbsp;    71, &quot;‚ùÑÔ∏è&quot;, 80, &quot;üå¶Ô∏è&quot;, 95, &quot;‚õàÔ∏è&quot;</b>
&nbsp;  );
&nbsp;
&nbsp;  // B·∫£n ƒë·ªì m√£ th·ªùi ti·∫øt sang m√¥ t·∫£ ƒëi·ªÅu ki·ªán th·ªùi ti·∫øt b·∫±ng ti·∫øng Anh
<b class="nc">&nbsp;  private static final Map&lt;Integer, String&gt; WEATHER_CONDITIONS_EN = Map.of(</b>
<b class="nc">&nbsp;    0, &quot;Clear&quot;, 1, &quot;Mainly Clear&quot;, 2, &quot;Partly Cloudy&quot;, 3, &quot;Overcast&quot;</b>
&nbsp;  );
&nbsp;
&nbsp;  // B·∫£n ƒë·ªì m√£ th·ªùi ti·∫øt sang m√¥ t·∫£ ƒëi·ªÅu ki·ªán th·ªùi ti·∫øt b·∫±ng ti·∫øng Vi·ªát
<b class="nc">&nbsp;  private static final Map&lt;Integer, String&gt; WEATHER_CONDITIONS_VI = Map.of(</b>
<b class="nc">&nbsp;    0, &quot;Tr·ªùi quang&quot;, 1, &quot;C√≥ n·∫Øng nh·∫π&quot;, 2, &quot;C√≥ m√¢y r·∫£i r√°c&quot;, 3, &quot;Tr·ªùi √¢m u&quot;</b>
&nbsp;  );
&nbsp;
&nbsp;  /**
&nbsp;   * L·∫•y bi·ªÉu t∆∞·ª£ng th·ªùi ti·∫øt t·ª´ m√£ th·ªùi ti·∫øt
&nbsp;   * @param code M√£ th·ªùi ti·∫øt
&nbsp;   * @return Bi·ªÉu t∆∞·ª£ng t∆∞∆°ng ·ª©ng ho·∫∑c m·∫∑c ƒë·ªãnh l√† üå°Ô∏è
&nbsp;   */
&nbsp;  private String getWeatherIcon(int code) {
<b class="nc">&nbsp;    return WEATHER_ICONS.getOrDefault(code, &quot;üå°Ô∏è&quot;);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * L·∫•y m√¥ t·∫£ ƒëi·ªÅu ki·ªán th·ªùi ti·∫øt b·∫±ng ti·∫øng Anh
&nbsp;   * @param code M√£ th·ªùi ti·∫øt
&nbsp;   * @return M√¥ t·∫£ t∆∞∆°ng ·ª©ng ho·∫∑c &quot;Unknown&quot; n·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c
&nbsp;   */
&nbsp;  private String getWeatherConditionEn(int code) {
<b class="nc">&nbsp;    return WEATHER_CONDITIONS_EN.getOrDefault(code, &quot;Unknown&quot;);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * L·∫•y m√¥ t·∫£ ƒëi·ªÅu ki·ªán th·ªùi ti·∫øt b·∫±ng ti·∫øng Vi·ªát
&nbsp;   * @param code M√£ th·ªùi ti·∫øt
&nbsp;   * @return M√¥ t·∫£ t∆∞∆°ng ·ª©ng ho·∫∑c &quot;Kh√¥ng x√°c ƒë·ªãnh&quot; n·∫øu kh√¥ng t√¨m th·∫•y
&nbsp;   */
&nbsp;  private String getWeatherConditionVi(int code) {
<b class="nc">&nbsp;    return WEATHER_CONDITIONS_VI.getOrDefault(code, &quot;Kh√¥ng x√°c ƒë·ªãnh&quot;);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * L·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt v√† th√¥ng tin v·ªã tr√≠ t·ª´ API
&nbsp;   * @param latitude Vƒ© ƒë·ªô
&nbsp;   * @param longitude Kinh ƒë·ªô
&nbsp;   * @param startHour Gi·ªù b·∫Øt ƒë·∫ßu d·ª± b√°o
&nbsp;   * @param endHour Gi·ªù k·∫øt th√∫c d·ª± b√°o
&nbsp;   * @param timezone M√∫i gi·ªù
&nbsp;   * @return ƒê·ªëi t∆∞·ª£ng Mono ch·ª©a th√¥ng tin th·ªùi ti·∫øt
&nbsp;   */
&nbsp;  public Mono&lt;?&gt; getWeatherData(double latitude, double longitude, String startHour, String endHour, String timezone) {
<b class="nc">&nbsp;    String weatherApiUrl = &quot;https://api.open-meteo.com/v1/forecast&quot;;</b>
<b class="nc">&nbsp;    String geoApiUrl = &quot;https://nominatim.openstreetmap.org/reverse&quot;;</b>
&nbsp;
&nbsp;    // G·ªçi API th·ªùi ti·∫øt
<b class="nc">&nbsp;    Mono&lt;String&gt; weatherJsonMono = webClient.mutate().baseUrl(weatherApiUrl).build().get()</b>
<b class="nc">&nbsp;      .uri(uriBuilder -&gt; uriBuilder.queryParam(&quot;latitude&quot;, latitude)</b>
<b class="nc">&nbsp;        .queryParam(&quot;longitude&quot;, longitude)</b>
<b class="nc">&nbsp;        .queryParam(&quot;hourly&quot;, &quot;temperature_2m,weather_code,relative_humidity_2m,uv_index&quot;)</b>
<b class="nc">&nbsp;        .queryParam(&quot;start_hour&quot;, startHour)</b>
<b class="nc">&nbsp;        .queryParam(&quot;end_hour&quot;, endHour)</b>
<b class="nc">&nbsp;        .queryParam(&quot;current&quot;, &quot;temperature_2m,weather_code,relative_humidity_2m,uv_index&quot;)</b>
<b class="nc">&nbsp;        .queryParam(&quot;timezone&quot;, timezone)</b>
<b class="nc">&nbsp;        .build())</b>
<b class="nc">&nbsp;      .retrieve().bodyToMono(String.class).onErrorReturn(&quot;{}&quot;);</b>
&nbsp;
&nbsp;    // G·ªçi API v·ªã tr√≠
<b class="nc">&nbsp;    Mono&lt;String&gt; geoJsonMono = webClient.mutate().baseUrl(geoApiUrl).build().get()</b>
<b class="nc">&nbsp;      .uri(uriBuilder -&gt; uriBuilder.queryParam(&quot;format&quot;, &quot;json&quot;)</b>
<b class="nc">&nbsp;        .queryParam(&quot;lat&quot;, latitude)</b>
<b class="nc">&nbsp;        .queryParam(&quot;lon&quot;, longitude)</b>
<b class="nc">&nbsp;        .queryParam(&quot;zoom&quot;, 10)</b>
<b class="nc">&nbsp;        .build())</b>
<b class="nc">&nbsp;      .retrieve().bodyToMono(String.class).onErrorReturn(&quot;{}&quot;);</b>
&nbsp;
&nbsp;    // X·ª≠ l√Ω k·∫øt qu·∫£ t·ª´ c·∫£ hai API
<b class="nc">&nbsp;    return Mono.zip(weatherJsonMono, geoJsonMono).map(tuple -&gt; {</b>
<b class="nc">&nbsp;      String weatherJson = tuple.getT1();</b>
<b class="nc">&nbsp;      String geoJson = tuple.getT2();</b>
&nbsp;
&nbsp;      try {
<b class="nc">&nbsp;        OpenMeteoResponseDTO response = objectMapper.readValue(weatherJson, OpenMeteoResponseDTO.class);</b>
&nbsp;
&nbsp;        // Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng Weather v√† √°nh x·∫° d·ªØ li·ªáu
<b class="nc">&nbsp;        OpenMeteoResponseDTO.CurrentWeather currentWeather = response.getCurrent();</b>
<b class="nc">&nbsp;        WeatherDTO weatherDTO = new WeatherDTO();</b>
<b class="nc">&nbsp;        weatherDTO.setTemperature(currentWeather.getTemperature_2m());</b>
<b class="nc">&nbsp;        weatherDTO.setCondition(getWeatherConditionEn(currentWeather.getWeather_code()));</b>
<b class="nc">&nbsp;        weatherDTO.setConditionText(getWeatherConditionVi(currentWeather.getWeather_code()));</b>
<b class="nc">&nbsp;        weatherDTO.setLocation(objectMapper.readTree(geoJson).path(&quot;display_name&quot;).asText(&quot;Unknown&quot;));</b>
<b class="nc">&nbsp;        weatherDTO.setHumidity(currentWeather.getRelative_humidity_2m());</b>
<b class="nc">&nbsp;        weatherDTO.setUvIndex(currentWeather.getUv_index());</b>
&nbsp;
&nbsp;        // T·∫°o danh s√°ch d·ª± b√°o theo gi·ªù
<b class="nc">&nbsp;        List&lt;HourlyForecastDTO&gt; hourlyForecastDTOS = IntStream.range(0, response.getHourly().getTime().size())</b>
<b class="nc">&nbsp;          .mapToObj(i -&gt; new HourlyForecastDTO(</b>
<b class="nc">&nbsp;            response.getHourly().getTime().get(i),</b>
<b class="nc">&nbsp;            response.getHourly().getTemperature_2m().get(i),</b>
<b class="nc">&nbsp;            getWeatherIcon(response.getHourly().getWeather_code().get(i))</b>
<b class="nc">&nbsp;          )).collect(Collectors.toList());</b>
&nbsp;
<b class="nc">&nbsp;        weatherDTO.setForecast(hourlyForecastDTOS);</b>
<b class="nc">&nbsp;        return weatherDTO;</b>
&nbsp;      } catch (Exception e) {
<b class="nc">&nbsp;        throw new RuntimeException(&quot;L·ªói khi ph√¢n t√≠ch JSON th·ªùi ti·∫øt&quot;, e);</b>
&nbsp;      }
&nbsp;    });
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-05-06 22:47</div>
</div>
</body>
</html>
